@model GeneralLedger.SelfServiceCore.Data.DTOs.PQRSFShowDTO
@{
    ViewData["Title"] = "Detalles de PQRSF #" + Model.Id;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-7">
        <div class="desktop-sticky-top">
            <div class="card border-0">
                <div class="col-md-12 px-2 pt-2">
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">PQRSF</a></li>
                        <li class="breadcrumb-item active">Detalles de la PQRSF</li>
                    </ul>
                </div>
                <div class="card-body">
                    <div>
                        <div class="row">
                            <div class="col-md-12 mb-2">
                                <div class="d-flex">
                                    <h4 class="py-0 my-0">@Model.Asunto</h4>
                                    <div class="mx-2">
                                        <span class="badge bg-info bg-opacity-20 text-info fw-bold" style="font-size:0.9rem"># @Model.Id</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="row">
                                        <label for="" class="form-label">Fecha de radicación:</label>
                                        <div>
                                            <span class="badge bg-success bg-opacity-20 text-success fw-bold" style="font-size:0.8rem"> 
                                                <i class="far fa-calendar-plus"></i>
                                                @String.Format("{0:MMM dd yyyy}", Model.Fecha).ToUpper() a las @String.Format("{0:t}", Model.Fecha).ToUpper()
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="row">
                                        <label for="" class="form-label">Cliente:</label>
                                        <div>
                                            @Html.DisplayFor(model =>model.NombreCliente)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row my-3">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="row">
                                        <label for="" class="form-label">Tipo de reseña:</label>
                                        <div>
                                            @if(Model.TipoSituacion == "PETICIÓN"){
                                                <span class="badge bg-teal bg-opacity-20 text-teal" style="font-size:0.8rem">@Model.TipoSituacion</span>
                                            }

                                            @if(Model.TipoSituacion == "QUEJA"){
                                                <span class="badge bg-indigo bg-opacity-20 text-indigo" style="font-size:0.8rem">@Model.TipoSituacion</span>
                                            }

                                            @if(Model.TipoSituacion == "RECLAMO"){
                                                <span class="badge bg-purple bg-opacity-20 text-purple" style="font-size:0.8rem">@Model.TipoSituacion</span>
                                            }

                                            @if(Model.TipoSituacion == "SUGERENCIA"){
                                                <span class="badge bg-yellow bg-opacity-20 text-yellow" style="font-size:0.8rem">@Model.TipoSituacion</span>
                                            }

                                            @if(Model.TipoSituacion == "FELICITACIÓN"){
                                                <span class="badge bg-info bg-opacity-20 text-info" style="font-size:0.7rem">@Model.TipoSituacion</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex">
                                    <div class="row">
                                        <label for="" class="form-label">Estado:</label>
                                        <div>
                                            @if(Model.Estado == "Abierta")
                                            {
                                                <span class="badge bg-success bg-opacity-20 text-success" style="font-size:0.8rem"><i class="fas fa-heartbeat fa-lg"></i> @Model.Estado</span>
                                            }
                                            @if(Model.Estado == "Cerrada")
                                            {
                                                <span class="badge bg-dark bg-opacity-20 text-dark" style="font-size:0.8rem"><i class="fas fa-heartbeat fa-lg"></i> @Model.Estado</span>
                                            }
                                            @if(Model.Estado == "En Gestión")
                                            {
                                                <span class="badge bg-warning bg-opacity-20 text-warning" style="font-size:0.8rem"><i class="fas fa-heartbeat fa-lg"></i> @Model.Estado</span>
                                            }
                                            @if(Model.Estado == "Nueva")
                                            {
                                                <span class="badge bg-primary bg-opacity-20 text-primary" style="font-size:0.8rem"><i class="fas fa-heartbeat fa-lg"></i> @Model.Estado</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row my-3">
                            <div class="col-md-12">
                                <label for="" class="form-label">Datos de contacto:</label>
                            </div>
                            <div class="col-md-6 p-0 m-0">
                                <div class="list-group list-group-flush py-0 my-0">
                                    <div class="list-group-item d-flex align-items-center py-0 my-0">
                                        <div class="me-1 py-0 my-0">
                                            <div class="w-30px h-30px d-flex align-items-center">
                                                <i class="far fa-address-book fa-lg"></i>
                                            </div>
                                        </div>
                                        <div class="py-0 my-0">
                                            <div class="py-0 my-0">
                                                <h6 class="py-0 my-0">@Model.NombreContacto</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="list-group list-group-flush py-0 my-0">
                                    <div class="list-group-item d-flex align-items-center py-0 my-0">
                                        <div class="me-1 py-0 my-0">
                                            <div class="w-30px h-30px d-flex align-items-center">
                                                <i class="fas fa-phone fa-lg"></i>
                                            </div>
                                        </div>
                                        <div class="py-0 my-0">
                                            <div class="py-0 my-0">
                                                <h6 class="py-0 my-0">@Model.Telefono</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*  *@
                            <div class="col-md-6 p-0 m-0">
                                <div class="list-group list-group-flush py-0 my-0">
                                    <div class="list-group-item d-flex align-items-center py-0 my-0">
                                        <div class="me-1 py-0 my-0">
                                            <div class="w-30px h-30px d-flex align-items-center">
                                                <i class="fas fa-envelope fa-lg"></i>
                                            </div>
                                        </div>
                                        <div class="py-0 my-0">
                                            <div class="py-0 my-0">
                                                <h6 class="py-0 my-0">@Model.Email</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="list-group list-group-flush py-0 my-0">
                                    <div class="list-group-item d-flex align-items-center py-0 my-0">
                                        <div class="me-1 py-0 my-0">
                                            <div class="w-30px h-30px d-flex align-items-center">
                                                <i class="fas fa-phone fa-lg"></i>
                                            </div>
                                        </div>
                                        <div class="py-0 my-0">
                                            <div class="py-0 my-0">
                                                <h6 class="py-0 my-0">@Model.Celular</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />

                        <div class="row my-3">
                            <div class="col-md-12">
                                <label for="" class="form-label">Descripción:</label>
                            </div>

                            <div class="col-md-12">
                                @Html.Raw(Model.DescripcionSituacion.Replace("<img","<img class='img-fluid'"))
                            </div>
                            <div class="col-md-12 mt-2">
                                <label for="" class="form-label">Archivos Adjuntos:</label>
                            </div>

                            <div class="col-md-12">
                                <div class="mailbox">                           
                                    <div class="mailbox-content p-0 m-0">
                                        <div class="mailbox-detail p-0 m-0">
                                            <div class="mailbox-detail-content p-0 m-0">
                                                <div class="mailbox-detail-attachment p-0 m-0">
                                                         
                                                    @if (Model.ListArchivos.Count > 0)
                                                    {
                                                        foreach (var archivo in Model.ListArchivos)
                                                        {
                                                            <div class="mailbox-attachment">
                                                                @* <a asp-action="DownLoadArchivo" asp-route-id="@archivo.Nombre&&&&@archivo.ContentType"> *@
                                                                <div class="document-file">
                                                                    @if(archivo.ContentType.Contains("image"))
                                                                    {
                                                                        <img src="@archivo.Url" alt="@archivo.Nombre" onclick="ViewPicture('@archivo.Url','@archivo.Nombre')">
                                                                    }else
                                                                    {
                                                                        <i class="fa fa-file-archive"></i>
                                                                    }
                                                                </div>
                                                                <a asp-action="DownLoadArchivo" asp-route-id="@archivo.Nombre&&&&@archivo.ContentType&&&&@archivo.Url" class="document-name d-inline-block text-truncate">@archivo.Nombre</a>
                                                               @* <div class="document-name d-inline-block text-truncate" style="max-width: 120px;">@archivo.Nombre</div>*@
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="col-md-12">
                                                            <label for="">No hay archivos adjuntos</label>
                                                        </div>
                                                    }
                                              
                                                </div>
                                            </div>                         
                                        </div>                          
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <a asp-action="Index" class="btn btn-secondary">Volver</a>
                                @* <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Editar</a> *@
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card border-0">
            <div class="toast-header my-0">
                <h5 class="fs-5 mt-0 mb-0">Respuestas</h5>
                <div class="container text-end mx-0 px-0">
                    <button id="note" class="btn btn-secondary btn-sm">
                        <i class="fas fa-reply me-1"></i> Responder
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if(Model.ListNotas.Count > 0)
                {
                    foreach(var item in Model.ListNotas)
                    {
                        
                        <div class="card border-0 bg-light bg-opacity-20 mb-1">
                            <div class="card-body">
                                <div class="row bg-transparent">
                                    <div class="col-md-12 bg-transparent">
                                        <div class="list-group list-group-flush bg-transparent">
                                            <div class="list-group-item d-flex px-3 py-0 bg-transparent">
                                                <div class="me-1">
                                                    <div class="w-40px h-40px d-flex align-items-center justify-content-center bg-secondary text-white rounded-circle ms-n1">
                                                        <i class="fa-solid fa-user"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-fill">
                                                    <div class="py-0 mx-0 my-0">
                                                        <p class="fw-bold py-0 px-0 mx-0 my-0" style="font-size: 0.8rem;"><b class="text-primary fw-bold">@item.Autor</b>    <b class="fw-normal"> respondió</b></p>  
                                                        <span class="badge bg-transparent bg-opacity-20 text-dark fw-normal fst-italic py-0 my-0" style="font-size:0.7rem"> 
                                                                <i class="far fa-calendar-plus"></i>
                                                                @String.Format("{0:MMM dd yyyy}", item.Fecha).ToUpper() a las @String.Format("{0:t}", item.Fecha).ToUpper()
                                                        </span>                                                                       
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">                                                     
                                        <div class="list-group list-group-flush bg-transparent">
                                            <div class="list-group-item d-flex px-3 bg-transparent">
                                                <div class="me-1"> 
                                                    <div class="w-40px h-40px d-flex align-items-center justify-content-center rounded-circle ms-n1">
                                                        <i class="fa-solid fa-sticky-note"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-fill">
                                                    <div class="py-0 mx-0 my-0">
                                                        @Html.Raw(item.Nota.Replace("<img","<img class='img-fluid'"))
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                   
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                <div class="row">
                    <div id="text-summernote" class="col-md-12 py-2 px-3" style="display: none;">
                        <form id="form-answer-pqrsf" method="post">
                            <div class="form-group">
                                <textarea id="Nota" name="Nota" class="form-control" placeholder="Escribe aquí una respuesta..." cols="30" rows="4" style="resize: none;display:none"></textarea>
                                <textarea class="summernote" name="summernote" id="summernote" cols="30" rows="10"></textarea>
                                <input type="hidden" id="Tipo" name="Tipo"/>
                                <input type="hidden" id="IdPQRSF" name="IdPQRSF" value="@Model.Id"/>
                            </div>
                            <div class="form-group border p-1">
                                <button id="btn-cancel-answer" type="button" class="btn btn-default btn-sm mx-2">Cancelar</button>
                                <button id="btn-answer" type="button" class="btn btn-success btn-sm">Enviar</button>
                            </div>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!--***************************************MODAL IMAGENES*************************************************************************-->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="modal-picture-pqrsf">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                <div id="container-picture" class="container py-0 px-0 d-flex justify-content-center">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="@Url.Content("~/validations/PQRSF/details.js")" type="text/javascript"></script>
    <script>
        $(document).ready(()=>{
            var message = "@TempData["MessageProfiler"]";
            if (message != "" && message != null && message != undefined) {
                ToastAlert.fire({icon: 'success',title: message}); 
            }
            
            $('.summernote').summernote({
                height: 160,
                minHeight: 160,             
                maxHeight: 160,  
                placeholder: 'Escriba una respuesta...',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                callbacks: {
                    onImageUpload: function (files) {
                        var formData = new FormData();
                        formData.append('file', files[0]);

                        $.ajax({
                            url: '/PQRSF/UploadImageSummerNote', // Ruta del controlador en ASP.NET Core
                            method: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function (response) {
                                var imageUrl = response.filePath;
                                var image = $('<img>').attr('src', '/Temp/Trash' + imageUrl);
                                console.log(image);
                                $('.summernote').summernote('insertNode', image[0]);
                            },
                            error: function (xhr, status, error) {
                                console.error(xhr.responseText);
                            }
                        });
                    }
                }
            });

            $("#note").on("click",()=>{
                $("#form-answer-pqrsf #Tipo").val("Nota");
                $("#text-summernote").css("display", "block");
                $("#note").css("display","none");
                $('html, body').animate({
                    scrollTop: $("#text-summernote").offset().top
                }, 300);
            });

            $("#btn-cancel-answer").on("click",()=>{
                $("#text-summernote").css("display", "none");
                $("#note").css("display","block");
            });

            
            $("#btn-answer").on("click",()=>{
                let form = $('#form-answer-pqrsf');

                if ($('#summernote').summernote('isEmpty') == false)
                    $("#Nota").val($("#summernote").summernote("code"));

                if($('#form-answer-pqrsf').valid() && !($('#summernote').summernote('isEmpty'))){
                    $.ajax({
                        url: "@Url.Action("AnswerPQRSF", "PQRSF")",
                        type: "POST",
                        data: form.serialize(),
                        beforeSend: function () {
                            $("#btn-answer").prop("disabled",true);
                        },
                        success: function (response) {
                            
                            if (response.result) {
                                window.location.href = "@Url.Action("Details", "PQRSF")";
                            } else {
                                ToastAlert.fire({icon: 'error',title: "Ups! Ha ocurrido algo inesperado, intente nuevamente"}); 
                            }
                        },
                    });
                }
                
            });
        });

        function ViewPicture(urlPicture,alt){
            let pictureModal = new bootstrap.Modal(document.getElementById("modal-picture-pqrsf"), {});
            let containerPicture = $("#container-picture");
            containerPicture.empty();
            containerPicture.append(`<img class="img-fluid" src="${urlPicture}" alt="${alt}">`);
            pictureModal.show();
        }
    </script>
}

